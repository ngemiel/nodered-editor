<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NodeBlu Fonnte Edition – Langsung Kirim WA</title>
<style>
  body{margin:0;font-family:-apple-system,Arial,sans-serif;background:#f0f0f0;overflow:hidden}
  #toolbar{padding:12px;background:#25D366;color:white;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.2);
    display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:8px}
  button{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;
    background:white;color:#25D366;font-size:14px}
  button:hover{background:#e8f5e9}
  #fonnteTokenBtn{background:#ff9800;color:white}
  #canvas{height:80vh;position:relative;background:#fdfdfd;overflow:hidden}
  .node{position:absolute;width:130px;height:70px;border:2px solid #000;border-radius:8px;
    text-align:center;line-height:70px;cursor:move;user-select:none;box-shadow:0 3px 8px rgba(0,0,0,0.15);
    font-weight:bold;font-size:13px;color:#000}
  .node.input{background:#A8E6CF;border-color:#1b5e20}
  .node.whatsapp{background:#A8E6CF;border-color:#25D366}
  .port{width:16px;height:16px;background:#000;border-radius:50%;position:absolute;
    top:50%;transform:translateY(-50%)}
  .port.in{left:-8px}.port.out{right:-8px}
  svg.connections{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}
  svg.connections path{fill:none;stroke:#25D366;stroke-width:5}
  #editModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);
    display:none;z-index:10000;align-items:center;justify-content:center}
  #editModal .modal-content{background:white;padding:25px;border-radius:12px;width:340px;max-width:90%;
    box-shadow:0 10px 30px rgba(0,0,0,0.4)}
  #editModal input,#editModal textarea{width:100%;margin:10px 0;padding:12px;border:1px solid #ccc;
    border-radius:6px;font-family:monospace;font-size:13px}
  #editModal button{padding:12px;background:#25D366;color:white;border:none;border-radius:6px;
    cursor:pointer;margin:5px 0;width:100%;font-weight:bold}
</style>
</head>
<body>

<div id="toolbar">
  <h2 style="margin:0 10px 0 0;font-size:18px">NodeBlu Fonnte</h2>
  <button onclick="addNode('input')">+ Inject</button>
  <button onclick="addNode('whatsapp')">+ WhatsApp</button>
  <button id="fonnteTokenBtn" onclick="setFonnteToken()">⚙️ Set Token Fonnte</button>
  <button onclick="saveFlow()">Simpan</button>
  <button onclick="loadFlow()">Muat</button>
  <button onclick="resetCanvas()" style="background:#d50000;color:white">Reset</button>
</div>

<div id="canvas"><svg class="connections"></svg></div>

<div id="editModal">
  <div class="modal-content">
    <h3>Edit Node</h3>
    <input id="editLabel" placeholder="Label">
    <div id="dynamicForm"></div>
    <div style="display:flex;gap:10px;margin-top:15px">
      <button onclick="saveEdit()">Simpan</button>
      <button onclick="closeEdit()" style="background:#d50000">Batal</button>
    </div>
  </div>
</div>

<script>
// === DATA ===
let nodes = JSON.parse(localStorage.getItem('nodes_wa') || '[]');
let edges = JSON.parse(localStorage.getItem('edges_wa') || '[]');
let dragging = null, connecting = null, editingNode = null;
let fonnteToken = localStorage.getItem('fonnte_token') || '';

// === FUNGSI UTAMA ===
const canvas = document.getElementById('canvas');
const svg = document.querySelector('svg.connections');
const editModal = document.getElementById('editModal');

function addNode(type) {
  const newNode = {
    id: 'n' + Date.now(),
    type,
    x: 100 + Math.random() * 500,
    y: 100 + Math.random() * 300,
    label: type === 'input' ? 'Inject' : 'WhatsApp',
    config: type === 'whatsapp' ? {target: '628xxxxxxxxxx', message: 'Halo dari NodeBlu!'} : {}
  };
  nodes.push(newNode);
  render(); saveFlow();
}

function createNode(n) {
  const div = document.createElement('div');
  div.className = `node ${n.type}`;
  div.id = n.id;
  div.innerText = n.label;
  div.style.left = n.x + 'px';
  div.style.top = n.y + 'px';

  // Port
  ['in','out'].forEach(p => {
    const port = document.createElement('div');
    port.className = `port ${p}`;
    div.appendChild(port);
  });

  // Tombol Trigger (hanya di Inject)
  if (n.type === 'input') {
    const btn = document.createElement('button');
    btn.innerText = '▶';
    btn.style.cssText = 'position:absolute;right:8px;top:8px;padding:4px 10px;background:#25D366;color:white;border:none;border-radius:50%;font-size:16px;cursor:pointer;z-index:10';
    btn.onclick = e => { e.stopPropagation(); triggerFlowFrom(n.id); };
    div.appendChild(btn);
  }

  // Event
  div.ondblclick = e => { e.stopPropagation(); showEdit(n); };
  div.oncontextmenu = e => { e.preventDefault(); if(confirm('Hapus node ini?')) deleteNode(n.id); };
  div.onmousedown = e => {
    if (e.target.classList.contains('port')) return;
    dragging = {node:n, ox:e.clientX-n.x, oy:e.clientY-n.y};
  };
  div.querySelector('.port.out').onmousedown = e => { e.stopPropagation(); connecting = {source: n.id}; };
  div.querySelector('.port.in').onmouseup = e => {
    if (connecting && connecting.source !== n.id) {
      edges = edges.filter(ed => !(ed.source === connecting.source && ed.target === n.id));
      edges.push({source: connecting.source, target: n.id});
      connecting = null; render(); saveFlow();
    }
  };
  return div;
}

function render() {
  document.querySelectorAll('.node').forEach(el=>el.remove());
  nodes.forEach(n => canvas.appendChild(createNode(n)));
  drawLines();
}

function drawLines() {
  svg.innerHTML = '';
  edges.forEach(e => {
    const s = nodes.find(x=>x.id===e.source);
    const t = nodes.find(x=>x.id===e.target);
    if (!s || !t) return;
    const x1 = s.x + 138, y1 = s.y + 35;
    const x2 = t.x - 8, y2 = t.y + 35;
    const ctrl = Math.abs(x2-x1)*0.5;
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M${x1},${y1} C${x1+ctrl},${y1} ${x2-ctrl},${y2} ${x2},${y2}`);
    svg.appendChild(path);
  });
}

// Drag global
document.onmousemove = e => {
  if (dragging) {
    dragging.node.x = e.clientX - dragging.ox;
    dragging.node.y = e.clientY - dragging.oy;
    render(); saveFlow();
  }
};
document.onmouseup = () => { dragging = null; connecting = null; };

// === KIRIM WHATSAPP VIA FONNTE ===
async function sendFonnte(target, message) {
  if (!fonnteToken) {
    alert('Token Fonnte belum di-set! Klik tombol ⚙️ Set Token Fonnte dulu.');
    return false;
  }
  const url = 'https://api.fonnte.com/send';
  const body = new FormData();
  body.append('token', fonnteToken);
  body.append('target', target.replace(/[^0-9]/g,''));
  body.append('message', message);

  try {
    const res = await fetch(url, {method:'POST', body});
    const json = await res.json();
    if (json.status === true) {
      alert('✅ Pesan WhatsApp berhasil dikirim ke ' + target);
      return true;
    } else {
      alert('Gagal kirim: ' + json.reason);
      return false;
    }
  } catch (err) {
    alert('Error koneksi Fonnte: ' + err.message);
    return false;
  }
}

// Jalankan flow dari node Inject
async function triggerFlowFrom(startId) {
  const visited = new Set();
  const queue = [startId];

  while (queue.length) {
    const id = queue.shift();
    if (visited.has(id)) continue;
    visited.add(id);

    const node = nodes.find(n=>n.id===id);
    if (node.type === 'whatsapp') {
      await sendFonnte(node.config.target, node.config.message);
    }

    edges.filter(e=>e.source===id).forEach(e=>queue.push(e.target));
  }
}

// === EDIT NODE ===
function showEdit(node) {
  editingNode = node;
  document.getElementById('editLabel').value = node.label;
  const form = document.getElementById('dynamicForm');
  if (node.type === 'whatsapp') {
    form.innerHTML = `
      <input id="waTarget" placeholder="Nomor WA (628xxx)" value="${node.config.target||''}">
      <textarea id="waMessage" rows="4" placeholder="Pesan">${node.config.message||''}</textarea>
    `;
  } else form.innerHTML = '';
  editModal.style.display = 'flex';
}

function saveEdit() {
  editingNode.label = document.getElementById('editLabel').value || editingNode.label;
  if (editingNode.type === 'whatsapp') {
    editingNode.config.target = document.getElementById('waTarget').value;
    editingNode.config.message = document.getElementById('waMessage').value;
  }
  closeEdit(); render(); saveFlow();
}

function closeEdit() { editModal.style.display = 'none'; }

// === TOKEN FONNTE ===
function setFonnteToken() {
  const token = prompt('Masukkan Token Fonnte kamu:\n(dapat dari fonnte.com > API Token)', fonnteToken);
  if (token) {
    fonnteToken = token.trim();
    localStorage.setItem('fonnte_token', fonnteToken);
    alert('Token Fonnte berhasil disimpan!');
  }
}

// === STORAGE ===
function saveFlow() {
  localStorage.setItem('nodes_wa', JSON.stringify(nodes));
  localStorage.setItem('edges_wa', JSON.stringify(edges));
}
function loadFlow() { location.reload(); }
function resetCanvas() {
  if(confirm('Hapus semua?')) {
    nodes=[]; edges=[];
    localStorage.removeItem('nodes_wa');
    localStorage.removeItem('edges_wa');
    render();
  }
}
function deleteNode(id) {
  nodes = nodes.filter(n=>n.id!==id);
  edges = edges.filter(e=>e.source!==id && e.target!==id);
  render(); saveFlow();
}

// Init
render();
if (!fonnteToken) alert('Jangan lupa klik ⚙️ Set Token Fonnte dulu ya!');
</script>
</body>
</html>
