<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NodeBlu – Visual Flow Editor by Ngemiel</title>
<style>
  * { touch-action: manipulation; }
  body { margin:0; font-family:-apple-system,Arial,sans-serif; background:#f0f0f0; height:100vh; overflow:hidden; }
  #toolbar { padding:12px 8px; background:#0066ff; color:white; box-shadow:0 2px 10px rgba(0,0,0,0.2); position:relative; z-index:100;
    display:flex; flex-wrap:wrap; justify-content:center; gap:8px; overflow:auto; }
  button { padding:12px 16px; border:none; border-radius:8px; font-weight:bold; background:white; color:#0066ff; font-size:14px; min-width:44px; min-height:44px; }
  button:hover, button:active { background:#e3f2fd; }
  #exportBtn { background:#4caf50; color:white; }
  #resetBtn { background:#d50000; color:white; }
  .mqtt-in { background:#66BB6A !important; color:white !important; }
  .mqtt-out { background:#43A047 !important; color:white !important; }
  .http { background:#7E57C2 !important; color:white !important; }
  .social { background:#0088cc !important; color:white !important; }
  .social.whatsapp { background:#25D366 !important; }
  #canvas { height:calc(100vh - 70px); position:relative; background:#fdfdfd; overflow:hidden; touch-action:none; }
  .node { position:absolute; width:130px; height:70px; border:2px solid #000; border-radius:10px; text-align:center; line-height:70px;
    user-select:none; box-shadow:0 4px 12px rgba(0,0,0,0.2); font-weight:bold; font-size:14px; touch-action:none; }
  .node.input { background:#A8E6A1; border-color:#2e7d32; }
  .node.function { background:#B3E5FC; border-color:#01579b; }
  .node.output { background:#FFAB91; border-color:#d84315; }
  .node.mqtt-in { background:#A5D6A7; border-color:#2e7d32; }
  .node.mqtt-out { background:#81C784; border-color:#1b5e20; }
  .node.http { background:#B39DDB; border-color:#512da8; }
  .node.telegram { background:#7FD7FF; border-color:#0088cc; }
  .node.whatsapp { background:#A8E6CF; border-color:#25D366; }
  .port { width:18px; height:18px; background:#000; border-radius:50%; position:absolute; top:50%; transform:translateY(-50%); }
  .port.in { left:-9px; }
  .port.out { right:-9px; }
  svg.connections path { fill:none; stroke:#0066ff; stroke-width:6; }
  #contextMenu, #editModal { touch-action:auto; }
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="addNode('input')">+ Inject</button>
  <button onclick="addNode('function')">+ Function</button>
  <button onclick="addNode('output')">+ Debug</button>
  <button class="mqtt-in" onclick="addNode('mqtt-in')">MQTT In</button>
  <button class="mqtt-out" onclick="addNode('mqtt-out')">MQTT Out</button>
  <button class="http" onclick="addNode('http')">HTTP Req</button>
  <button class="social" onclick="addNode('telegram')">Telegram</button>
  <button class="social whatsapp" onclick="addNode('whatsapp')">WhatsApp</button>
  <button onclick="saveFlow()">Simpan</button>
  <button onclick="loadFlow()">Muat</button>
  <button onclick="deployFlow()" style="background:#ff9800;color:white">Deploy</button>
  <button id="exportBtn" onclick="exportFlow()">Export</button>
  <button id="resetBtn" onclick="resetCanvas()">Reset</button>
</div>

<div id="canvas"><svg class="connections"></svg></div>

<script>
  let nodes = JSON.parse(localStorage.getItem('nodes')||'[]');
  let edges = JSON.parse(localStorage.getItem('edges')||'[]');
  let dragging=null, connecting=null;

  const canvas = document.getElementById('canvas');
  const svg = document.querySelector('svg');

  function addNode(t) { nodes.push({id:'n'+Date.now(),type:t,x:50+Math.random()*400,y:50+Math.random()*400,label:t==='input'?'Inject':t==='whatsapp'?'WhatsApp':t[0].toUpperCase()+t.slice(1),config:{}}); render(); saveFlow(); }

  function render() {
    canvas.innerHTML = '<svg class="connections"></svg>';
    nodes.forEach(n=>{
      const d = document.createElement('div');
      d.className=`node ${n.type}`; d.id=n.id; d.textContent=n.label;
      d.style.left=n.x+'px'; d.style.top=n.y+'px';
      ['in','out'].forEach(p=>{const port=document.createElement('div');port.className=`port ${p}`;d.appendChild(port);});
      if(n.type==='input'){const b=document.createElement('button');b.textContent='▶';b.style.cssText='position:absolute;right:8px;top:8px;padding:4px 10px;background:#4caf50;color:white;border:none;border-radius:50%;font-size:18px;';b.onclick=e=>{e.stopPropagation();triggerNode(n.id);};d.appendChild(b);}
      d.ondblclick=()=>{/* edit modal kalau mau */};
      d.onmousedown = d.ontouchstart = e=>{if(e.target.classList.contains('port'))return; const t=e.touches?e.touches[0]:e; dragging={node:n,ox:t.clientX-n.x,oy:t.clientY-n.y};};
      d.querySelector('.port.out').onmousedown = d.querySelector('.port.out').ontouchstart = e=>{e.stopPropagation(); connecting={source:n.id};};
      d.querySelector('.port.in').onmouseup = d.querySelector('.port.in').ontouchend = ()=>{ if(connecting && connecting.source!==n.id){ edges=edges.filter(e=>!(e.source===connecting.source && e.target===n.id)); edges.push({source:connecting.source,target:n.id}); connecting=null; render(); saveFlow(); } };
      canvas.appendChild(d);
    });
    drawEdges();
  }

  function drawEdges() {
    svg.innerHTML='';
    edges.forEach(e=>{
      const s=nodes.find(x=>x.id===e.source);
      const t=nodes.find(x=>x.id===e.target);
      if(!s||!t)return;
      const x1=s.x+139, y1=s.y+35, x2=t.x-9, y2=t.y+35, c=Math.abs(x2-x1)*0.5;
      const p=document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d',`M${x1},${y1} C${x1+c},${y1} ${x2-c},${y2} ${x2},${y2}`);
      svg.appendChild(p);
    });
  }

  document.onmousemove = document.ontouchmove = e=>{
    if(!dragging)return;
    const t=e.touches?e.touches[0]:e;
    dragging.node.x = t.clientX - dragging.ox;
    dragging.node.y = t.clientY - dragging.oy;
    render(); saveFlow();
  };

  document.onmouseup = document.ontouchend = ()=>{ dragging=null; connecting=null; };

  function saveFlow(){ localStorage.setItem('nodes',JSON.stringify(nodes)); localStorage.setItem('edges',JSON.stringify(edges)); }
  function loadFlow(){ location.reload(); }
  function resetCanvas(){
    if(confirm('Hapus semua node & koneksi?')){
      nodes=[]; edges=[];
      localStorage.removeItem('nodes');
      localStorage.removeItem('edges');
      render();
    }
  }
  function exportFlow(){ /* sama seperti sebelumnya */ }
  async function deployFlow(){ /* sama */ }
  async function triggerNode(id){ /* sama */ }

  render();
</script>
</body>
</html>
