<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drag & Drop Node-RED Editor @ngemiel</title>
  <style>
    body { margin: 0; font-family: Arial; background: #f5f5f5; }
    #toolbar { padding: 15px; background: #d32f2f; color: white; text-align: center; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
    button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: white; color: #d32f2f; }
    button:hover { background: #ffebee; }
    #exportBtn { background: #4caf50; color: white; }
    #canvas { height: 80vh; border: 2px dashed #ccc; position: relative; background: white; overflow: auto; }
    .node { position: absolute; width: 100px; height: 50px; background: #ADD8E6; border: 1px solid #000; border-radius: 5px; text-align: center; line-height: 50px; cursor: move; user-select: none; z-index: 10; }
    .node.input { background: #90EE90; }
    .node.function { background: #ADD8E6; }
    .node.output { background: #FFB6C1; }
    .port { width: 10px; height: 10px; background: #000; border-radius: 50%; position: absolute; }
    .port.left { left: -5px; top: 50%; transform: translateY(-50%); }
    .port.right { right: -5px; top: 50%; transform: translateY(-50%); }
    a { color: white; text-decoration: underline; }
  </style>
</head>
<body>
  <div id="toolbar">
    <h2>NodeRED Drag & Drop Editor @ngemiel</h2>
    <button onclick="addNode('input')">+ Input Node</button>
    <button onclick="addNode('function')">+ Function Node</button>
    <button onclick="addNode('output')">+ Output Node</button>
    <button onclick="saveFlow()">Simpan</button>
    <button onclick="loadFlow()">Muat</button>
    <button id="exportBtn" onclick="exportFlow()">Export JSON</button>
    <input type="file" id="importFile" accept=".json" onchange="importFlow(event)" style="display:none;">
    <button onclick="document.getElementById('importFile').click()">Import JSON</button>
    <a href="/" style="margin-left:20px;">‚Üê Kembali ke JSON Editor</a>
  </div>
  <div id="canvas"></div>

  <script>
    let nodes = JSON.parse(localStorage.getItem('nodes') || '[]');
    let edges = JSON.parse(localStorage.getItem('edges') || '[]');

    function addNode(type) {
      const id = 'node-' + Date.now();
      const node = {
        id: id,
        type: type,
        x: Math.random() * 400 + 100,
        y: Math.random() * 300 + 100,
        label: type.charAt(0).toUpperCase() + type.slice(1) + ' Node'
      };
      nodes.push(node);
      render();
      saveFlow();
      console.log('Node ' + type + ' ditambahkan!'); // Cek console F12 kalau gak ada alert
    }

    function render() {
      const canvas = document.getElementById('canvas');
      canvas.innerHTML = '';
      nodes.forEach(node => {
        const div = document.createElement('div');
        div.className = 'node ' + node.type;
        div.id = node.id;
        div.innerText = node.label.substring(0, 10) + '...'; // Short label
        div.style.left = node.x + 'px';
        div.style.top = node.y + 'px';

        // Port left & right
        const leftPort = document.createElement('div');
        leftPort.className = 'port left';
        const rightPort = document.createElement('div');
        rightPort.className = 'port right';
        div.appendChild(leftPort);
        div.appendChild(rightPort);

        // Drag functionality
        let isDragging = false;
        let startX, startY;

        div.addEventListener('mousedown', (e) => {
          isDragging = true;
          startX = e.clientX - node.x;
          startY = e.clientY - node.y;
          div.style.zIndex = 100;
          canvas.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
          if (isDragging) {
            node.x = e.clientX - startX;
            node.y = e.clientY - startY;
            div.style.left = node.x + 'px';
            div.style.top = node.y + 'px';
          }
        });

        document.addEventListener('mouseup', (e) => {
          if (isDragging) {
            isDragging = false;
            div.style.zIndex = 10;
            canvas.style.cursor = 'default';
            saveFlow();
          }
        });

        canvas.appendChild(div);
      });
      // Render lines if edges exist (simple)
      edges.forEach(edge => {
        const line = document.createElement('div');
        line.style.position = 'absolute';
        line.style.borderTop = '2px solid #000';
        line.style.left = edge.startX + 'px';
        line.style.top = edge.startY + 'px';
        line.style.width = edge.length + 'px';
        line.style.height = '0';
        line.style.transform = 'rotate(' + edge.angle + 'deg)';
        canvas.appendChild(line);
      });
    }

    function saveFlow() {
      localStorage.setItem('nodes', JSON.stringify(nodes));
      localStorage.setItem('edges', JSON.stringify(edges));
    }

    function loadFlow() {
      location.reload();
    }

    function exportFlow() {
      const flow = nodes.map(n => ({
        id: n.id,
        type: n.type,
        name: n.label,
        x: n.x,
        y: n.y,
        wires: [] // Placeholder for connections
      }));
      const json = JSON.stringify(flow, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'flow-ngemiel.json';
      a.click();
      URL.revokeObjectURL(url);
      console.log('Export done!');
    }

    function importFlow(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          nodes = JSON.parse(e.target.result);
          render();
          console.log('Import done!');
        } catch (err) {
          console.error('Import error:', err);
        }
      };
      reader.readAsText(file);
    }

    // Initial load
    render();
  </script>
</body>
</html>
