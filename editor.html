<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Node-RED Web Editor @ngemiel</title>
  <style>
    body { margin: 0; font-family: Arial; background: #f5f5f5; }
    #toolbar { padding: 15px; background: #d32f2f; color: white; text-align: center; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
    button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: white; color: #d32f2f; }
    button:hover { background: #ffebee; }
    #exportBtn { background: #4caf50; color: white; }
    #canvas { height: 80vh; position: relative; background: white; overflow: hidden; }
    .node { position: absolute; width: 130px; height: 70px; background: #87CEFA; border: 3px solid #000; border-radius: 10px; text-align: center; line-height: 70px; cursor: move; user-select: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: bold; }
    .node.input { background: #90EE90; }
    .node.output { background: #FFB6C1; }
    .port { width: 16px; height: 16px; background: #000; border-radius: 50%; position: absolute; top: 50%; transform: translateY(-50%); cursor: crosshair; }
    .port.out { right: -8px; }
    .port.in { left: -8px; }
    .connection { position: absolute; pointer-events: none; }
    .connection path { fill: none; stroke: #000; stroke-width: 3; }
    #contextMenu { position: absolute; background: white; border: 2px solid #000; padding: 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: none; z-index: 1000; }
    #contextMenu button { display: block; width: 100%; margin: 5px 0; background: #d32f2f; color: white; }
    a { color: white; text-decoration: underline; }
  </style>
</head>
<body>
  <div id="toolbar">
    <h2>Node-RED Web Editor @ngemiel</h2>
    <button onclick="addNode('input')">+ Inject</button>
    <button onclick="addNode('function')">+ Function</button>
    <button onclick="addNode('output')">+ Debug</button>
    <button onclick="saveFlow()">Simpan</button>
    <button onclick="loadFlow()">Muat</button>
    <button id="exportBtn" onclick="exportFlow()">Export JSON</button>
    <a href="/" style="margin-left:20px;">‚Üê JSON Editor</a>
  </div>
  <div id="canvas"></div>
  <div id="contextMenu">
    <button onclick="deleteNode(currentNodeId)">üóëÔ∏è Delete Node</button>
    <button onclick="hideContextMenu()">Cancel</button>
  </div>

  <script>
    let nodes = JSON.parse(localStorage.getItem('nodes') || '[]');
    let edges = JSON.parse(localStorage.getItem('edges') || '[]');
    let dragging = null;
    let connecting = null;
    let currentNodeId = null;

    const canvas = document.getElementById('canvas');
    const contextMenu = document.getElementById('contextMenu');

    function addNode(type) {
      const node = {
        id: 'n' + Date.now(),
        type: type,
        x: 100 + Math.random() * 400,
        y: 100 + Math.random() * 300,
        label: type === 'input' ? 'Inject' : type === 'output' ? 'Debug' : 'Function'
      };
      nodes.push(node);
      render();
      saveFlow();
    }

    function render() {
      canvas.innerHTML = '';
      // Render connections (curved)
      edges.forEach(edge => {
        const sourceNode = nodes.find(n => n.id === edge.source);
        const targetNode = nodes.find(n => n.id === edge.target);
        if (!sourceNode || !targetNode) return;

        const x1 = sourceNode.x + 130 + 8;
        const y1 = sourceNode.y + 35;
        const x2 = targetNode.x - 8;
        const y2 = targetNode.y + 35;

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.className = 'connection';
        svg.style.left = Math.min(x1, x2) + 'px';
        svg.style.top = Math.min(y1, y2) + 'px';
        svg.style.width = Math.abs(x2 - x1) + 'px';
        svg.style.height = Math.abs(y2 - y1) + 'px';

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const ctrlX = (x1 + x2) / 2 + (x2 > x1 ? 80 : -80);
        path.setAttribute('d', `M${x1-Math.min(x1,x2)} ${y1-Math.min(y1,y2)} Q ${ctrlX-Math.min(x1,x2)} ${(y1+y2)/2} ${x2-Math.min(x1,x2)} ${y2-Math.min(y1,y2)}`);
        svg.appendChild(path);
        canvas.appendChild(svg);
      });

      // Render nodes
      nodes.forEach(node => {
        const div = document.createElement('div');
        div.className = 'node ' + node.type;
        div.id = node.id;
        div.innerText = node.label;
        div.style.left = node.x + 'px';
        div.style.top = node.y + 'px';

        const portIn = document.createElement('div');
        portIn.className = 'port in';
        const portOut = document.createElement('div');
        portOut.className = 'port out';
        div.appendChild(portIn);
        div.appendChild(portOut);

        // Right click ‚Üí delete
        div.addEventListener('contextmenu', e => {
          e.preventDefault();
          currentNodeId = node.id;
          contextMenu.style.left = e.clientX + 'px';
          contextMenu.style.top = e.clientY + 'px';
          contextMenu.style.display = 'block';
        });

        // Drag node
        div.addEventListener('mousedown', e => {
          if (e.button !== 0 || e.target.classList.contains('port')) return;
          dragging = { node, offsetX: e.clientX - node.x, offsetY: e.clientY - node.y };
        });

        // Start connection
        portOut.addEventListener('mousedown', e => {
          e.stopPropagation();
          connecting = { source: node.id, x: node.x + 138, y: node.y + 35 };
        });

        // End connection
        portIn.addEventListener('mouseup', e => {
          if (connecting && connecting.source !== node.id) {
            edges.push({ source: connecting.source, target: node.id });
            connecting = null;
            render();
            saveFlow();
          }
        });

        canvas.appendChild(div);
      });
    }

    function deleteNode(id) {
      nodes = nodes.filter(n => n.id !== id);
      edges = edges.filter(e => e.source !== id && e.target !== id);
      hideContextMenu();
      render();
      saveFlow();
    }

    function hideContextMenu() { contextMenu.style.display = 'none'; }

    // Global events
    document.addEventListener('mousemove', e => {
      if (dragging) {
        dragging.node.x = e.clientX - dragging.offsetX;
        dragging.node.y = e.clientY - dragging.offsetY;
        render();
        saveFlow();
      }
    });

    document.addEventListener('mouseup', () => {
      dragging = null;
      connecting = null;
    });

    document.addEventListener('click', () => hideContextMenu());

    function saveFlow() {
      localStorage.setItem('nodes', JSON.stringify(nodes));
      localStorage.setItem('edges', JSON.stringify(edges));
    }

    function loadFlow() { location.reload(); }

    function exportFlow() {
      const flow = nodes.map(n => ({
        id: n.id,
        type: n.type === 'input' ? 'inject' : n.type === 'output' ? 'debug' : 'function',
        name: n.label,
        x: n.x, y: n.y,
        wires: edges.filter(e => e.source === n.id).map(e => [e.target])
      }));
      const blob = new Blob([JSON.stringify(flow, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'flow-ngemiel.json'; a.click();
    }

    render();
  </script>
</body>
</html>
