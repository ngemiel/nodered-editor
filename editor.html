<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drag & Drop Node-RED Editor @ngemiel</title>
  <style>
    body { margin: 0; font-family: Arial; background: #f5f5f5; }
    #toolbar { padding: 15px; background: #d32f2f; color: white; text-align: center; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
    button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: white; color: #d32f2f; }
    button:hover { background: #ffebee; }
    #exportBtn { background: #4caf50; color: white; }
    #canvas { height: 80vh; position: relative; background: white; overflow: hidden; }
    .node { position: absolute; width: 120px; height: 60px; background: #ADD8E6; border: 2px solid #000; border-radius: 8px; text-align: center; line-height: 60px; cursor: move; user-select: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .node.input { background: #90EE90; }
    .node.function { background: #87CEFA; }
    .node.output { background: #FFB6C1; }
    .port { width: 14px; height: 14px; background: #000; border-radius: 50%; position: absolute; top: 50%; transform: translateY(-50%); cursor: crosshair; }
    .port.out { right: -7px; }
    .port.in { left: -7px; }
    .line { position: absolute; height: 3px; background: #000; transform-origin: 0 0; pointer-events: none; }
    a { color: white; text-decoration: underline; }
  </style>
</head>
<body>
  <div id="toolbar">
    <h2>NodeRED Drag & Drop Editor @ngemiel</h2>
    <button onclick="addNode('input')">+ Input Node</button>
    <button onclick="addNode('function')">+ Function Node</button>
    <button onclick="addNode('output')">+ Output Node</button>
    <button onclick="saveFlow()">Simpan</button>
    <button onclick="loadFlow()">Muat</button>
    <button id="exportBtn" onclick="exportFlow()">Export JSON</button>
    <a href="/" style="margin-left:20px;">‚Üê JSON Editor</a>
  </div>
  <div id="canvas"></div>

  <script>
    let nodes = JSON.parse(localStorage.getItem('nodes') || '[]');
    let edges = JSON.parse(localStorage.getItem('edges') || '[]');
    let dragging = null;
    let connecting = null;

    function addNode(type) {
      const node = {
        id: 'node-' + Date.now(),
        type: type,
        x: Math.random() * 500 + 100,
        y: Math.random() * 300 + 100,
        label: type === 'input' ? 'Inject' : type === 'output' ? 'Debug' : 'Function'
      };
      nodes.push(node);
      render();
      saveFlow();
    }

    function render() {
      const canvas = document.getElementById('canvas');
      canvas.innerHTML = '';
      
      // Render edges dulu (biar di bawah node)
      edges.forEach(edge => {
        const line = document.createElement('div');
        line.className = 'line';
        const dx = edge.targetX - edge.sourceX;
        const dy = edge.targetY - edge.sourceY;
        const length = Math.sqrt(dx*dx + dy*dy);
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
        line.style.left = edge.sourceX + 'px';
        line.style.top = edge.sourceY + 'px';
        line.style.width = length + 'px';
        line.style.transform = `rotate(${angle}deg)`;
        canvas.appendChild(line);
      });

      // Render nodes
      nodes.forEach(node => {
        const div = document.createElement('div');
        div.className = 'node ' + node.type;
        div.id = node.id;
        div.innerHTML = `<div style="font-weight:bold;">${node.label}</div>`;
        div.style.left = node.x + 'px';
        div.style.top = node.y + 'px';

        // Ports
        const portOut = document.createElement('div');
        portOut.className = 'port out';
        const portIn = document.createElement('div');
        portIn.className = 'port in';
        div.appendChild(portOut);
        div.appendChild(portIn);

        // Drag node
        div.addEventListener('mousedown', e => {
          if (e.target.classList.contains('port')) return;
          dragging = { node, offsetX: e.clientX - node.x, offsetY: e.clientY - node.y };
        });

        // Start connection
        portOut.addEventListener('mousedown', e => {
          e.stopPropagation();
          connecting = { source: node.id, x: node.x + 120 + 7, y: node.y + 30 };
        });

        // End connection
        portIn.addEventListener('mouseup', e => {
          if (connecting && connecting.source !== node.id) {
            edges.push({
              source: connecting.source,
              target: node.id,
              sourceX: connecting.x,
              sourceY: connecting.y,
              targetX: node.x - 7,
              targetY: node.y + 30
            });
            connecting = null;
            render();
            saveFlow();
          }
        });

        canvas.appendChild(div);
      });
    }

    // Global mouse move & up
    document.addEventListener('mousemove', e => {
      if (dragging) {
        dragging.node.x = e.clientX - dragging.offsetX;
        dragging.node.y = e.clientY - dragging.offsetY;
        render();
        saveFlow();
      }
      if (connecting) {
        connecting.x = e.clientX;
        connecting.y = e.clientY;
      }
    });

    document.addEventListener('mouseup', () => {
      dragging = null;
      connecting = null;
    });

    function saveFlow() {
      localStorage.setItem('nodes', JSON.stringify(nodes));
      localStorage.setItem('edges', JSON.stringify(edges));
    }

    function loadFlow() { location.reload(); }

    function exportFlow() {
      const flow = nodes.map(n => ({
        id: n.id,
        type: n.type === 'input' ? 'inject' : n.type === 'output' ? 'debug' : 'function',
        name: n.label,
        x: n.x, y: n.y,
        wires: edges.filter(e => e.source === n.id).map(e => [e.target])
      }));
      const blob = new Blob([JSON.stringify(flow, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'flow-ngemiel.json'; a.click();
    }

    // Start
    render();
  </script>
</body>
</html>
