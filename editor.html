<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Node-RED Web Editor @ngemiel</title>
  <style>
    body{margin:0;font-family:-apple-system,Arial,sans-serif;background:#f0f0f0;color:#000;transition:all .3s}
    .dark body{background:#121212;color:#eee}
    #toolbar{padding:12px;background:#d32f2f;color:white;box-shadow:0 2px 10px rgba(0,0,0,.2);display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:8px;position:relative}
    button{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;background:white;color:#d32f2f;font-size:14px}
    button:hover{background:#ffebee}
    .dark button{background:#333;color:#fff}
    .dark button:hover{background:#444}
    #exportBtn{background:#4caf50;color:white}
    #resetBtn{background:#d50000;color:white}
    .mqtt-in{background:#66BB6A;color:white}
    .mqtt-out{background:#43A047;color:white}
    .http{background:#7E57C2;color:white}
    .social{background:#0088cc;color:white}
    .social.whatsapp{background:#25D366}
    #canvas{height:80vh;position:relative;background:#fdfdfd;transition:all .3s}
    .dark #canvas{background:#1e1e1e}
    .node{position:absolute;width:100px;height:50px;border:2px solid #000;border-radius:8px;text-align:center;line-height:50px;cursor:move;user-select:none;box-shadow:0 3px 8px rgba(0,0,0,.15);font-weight:bold;font-size:13px;color:#000}
    .dark .node{color:#fff;border-color:#444;box-shadow:0 3px 10px rgba(0,0,0,.5)}
    .node.input{background:#A8E6A1;border-color:#2e7d32}
    .node.function{background:#B3E5FC;border-color:#01579b}
    .node.output{background:#FFAB91;border-color:#d84315}
    .node.mqtt-in{background:#A5D6A7;border-color:#2e7d32}
    .node.mqtt-out{background:#81C784;border-color:#1b5e20}
    .node.http{background:#B39DDB;border-color:#512da8}
    .node.telegram{background:#7FD7FF;border-color:#0088cc}
    .node.whatsapp{background:#A8E6CF;border-color:#25D366}
    .dark .node.telegram{background:#0088cc}
    .dark .node.whatsapp{background:#25D366}
    .port{width:12px;height:12px;background:#000;border-radius:50%;position:absolute;top:50%;transform:translateY(-50%);cursor:crosshair}
    .dark .port{background:#fff}
    svg.connections path{stroke:#000;stroke-width:3;transition:all .3s}
    .dark svg.connections path{stroke:#888}
    #themeBtn{position:absolute;right:15px;top:12px;background:#333;color:white;padding:8px 12px;font-size:20px;border-radius:50%;cursor:pointer}
    #editModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;z-index:10000;align-items:center;justify-content:center}
    .modal-content{background:white;padding:25px;border-radius:12px;width:340px;box-shadow:0 10px 30px rgba(0,0,0,0.4);color:#000}
    .dark .modal-content{background:#333;color:#eee}
    .modal-content input,.modal-content textarea{width:100%;margin:10px 0;padding:10px;border-radius:6px;border:1px solid #ccc;font-family:monospace}
    .dark .modal-content input{border-color:#555}
    .modal-content button{padding:10px;background:#d32f2f;color:white;border:none;border-radius:6px;cursor:pointer;width:100%;margin:5px 0}
    #contextMenu{position:absolute;background:white;border:2px solid #d32f2f;border-radius:8px;padding:8px;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:9999;display:none}
    .dark #contextMenu{background:#222;border-color:#d32f2f}
    a{color:white;text-decoration:underline;font-size:14px}
  </style>
</head>
<body>
  <div id="toolbar">
    <h2 style="margin:0 10px 0 0;font-size:18px">Node-RED Web Editor @ngemiel</h2>
    <button onclick="addNode('input')">+ Inject</button>
    <button onclick="addNode('function')">+ Function</button>
    <button onclick="addNode('output')">+ Debug</button>
    <button class="mqtt-in" onclick="addNode('mqtt-in')">MQTT In</button>
    <button class="mqtt-out" onclick="addNode('mqtt-out')">MQTT Out</button>
    <button class="http" onclick="addNode('http')">HTTP Req</button>
    <button class="social" onclick="addNode('telegram')">Telegram</button>
    <button class="social whatsapp" onclick="addNode('whatsapp')">WhatsApp</button>
    <button onclick="saveFlow()">Simpan</button>
    <button onclick="loadFlow()">Muat</button>
    <button id="exportBtn" onclick="exportFlow()">Export</button>
    <button id="resetBtn" onclick="resetCanvas()">Reset</button>
    <a href="/">‚Üê JSON Editor</a>
    <div id="themeBtn" onclick="toggleTheme()">Dark Mode</div>
  </div>
  <div id="canvas"><svg class="connections"></svg></div>
  <div id="contextMenu">
    <button onclick="deleteNode(currentNodeId)">Delete Node</button>
    <button onclick="hideContextMenu()">Cancel</button>
  </div>
  <div id="editModal">
    <div class="modal-content">
      <h3>Edit Node</h3>
      <input id="nodeLabel" placeholder="Label">
      <textarea id="nodeConfig" rows="8" placeholder='Telegram:\n{"token":"123456:ABC","chatId":"123456789"}\n\nHTTP:\n{"url":"https://indodax.com/api/ticker/btcidr"}'></textarea>
      <button onclick="saveNodeConfig()">Save</button>
      <button onclick="closeEditModal()">Cancel</button>
    </div>
  </div>

  <script>
    let nodes=JSON.parse(localStorage.getItem('nodes')||'[]');
    let edges=JSON.parse(localStorage.getItem('edges')||'[]');
    let dragging=null,connecting=null,currentNodeId=null,editingNode=null;
    const canvas=document.getElementById('canvas');
    const svg=document.querySelector('svg.connections');
    const contextMenu=document.getElementById('contextMenu');
    const editModal=document.getElementById('editModal');
    const themeBtn=document.getElementById('themeBtn');

    // Dark Mode
    if(localStorage.getItem('theme')==='dark'||(!localStorage.getItem('theme')&&window.matchMedia('(prefers-color-scheme: dark)').matches)){
      document.body.classList.add('dark'); themeBtn.textContent='Light Mode';
    }
    function toggleTheme(){
      document.body.classList.toggle('dark');
      const isDark=document.body.classList.contains('dark');
      themeBtn.textContent=isDark?'Light Mode':'Dark Mode';
      localStorage.setItem('theme',isDark?'dark':'light');
    }

    const labels={input:'Inject',function:'Function',output:'Debug','mqtt-in':'MQTT In','mqtt-out':'MQTT Out',http:'HTTP Req',telegram:'Telegram',whatsapp:'WhatsApp'};

    function addNode(t){
      nodes.push({id:'n'+Date.now(),type:t,x:150+Math.random()*600,y:100+Math.random()*300,label:labels[t],config:{}});
      render(); saveFlow();
    }

    function drawConnections(){
      svg.innerHTML='';
      edges.forEach(e=>{
        const s=nodes.find(n=>n.id===e.source);
        const d=nodes.find(n=>n.id===e.target);
        if(!s||!d)return;
        const x1=s.x+106,y1=s.y+25,x2=d.x-6,y2=d.y+25;
        const c=Math.abs(x2-x1)*0.5;
        const p=document.createElementNS('http://www.w3.org/2000/svg','path');
        p.setAttribute('d',`M${x1},${y1} C${x1+c},${y1} ${x2-c},${y2} ${x2},${y2}`);
        svg.appendChild(p);
      });
    }

    function renderNodes(){
      document.querySelectorAll('.node').forEach(n=>n.remove());
      nodes.forEach(n=>{
        const div=document.createElement('div');
        div.className=`node ${n.type}`; div.id=n.id; div.innerText=n.label;
        div.style.left=n.x+'px'; div.style.top=n.y+'px';

        // Double-click untuk edit
        div.addEventListener('dblclick', ()=>{editingNode=n; document.getElementById('nodeLabel').value=n.label; document.getElementById('nodeConfig').value=JSON.stringify(n.config||{},null,2); editModal.style.display='flex';});

        // Port In & Out (buat dulu, baru event)
        const portIn=document.createElement('div'); portIn.className='port in';
        const portOut=document.createElement('div'); portOut.className='port out';
        div.appendChild(portIn); div.appendChild(portOut);

        // Event koneksi (setelah port dibuat)
        portOut.addEventListener('mousedown',e=>{e.stopPropagation(); connecting={source:n.id};});
        portIn.addEventListener('mouseup',e=>{
          if(connecting && connecting.source!==n.id){
            edges=edges.filter(x=>!(x.source===connecting.source && x.target===n.id));
            edges.push({source:connecting.source, target:n.id});
            connecting=null; render(); saveFlow();
          }
        });

        div.addEventListener('contextmenu',e=>{e.preventDefault();currentNodeId=n.id;contextMenu.style.left=e.clientX+'px';contextMenu.style.top=e.clientY+'px';contextMenu.style.display='block';});
        div.addEventListener('mousedown',e=>{if(e.button!==0||e.target.classList.contains('port'))return;dragging={node:n,offsetX:e.clientX-n.x,offsetY:e.clientY-n.y};});
        canvas.appendChild(div);
      });
    }

    function render(){renderNodes();drawConnections();}
    document.addEventListener('mousemove',e=>{if(dragging){dragging.node.x=e.clientX-dragging.offsetX;dragging.node.y=e.clientY-dragging.offsetY;render();saveFlow();}});
    document.addEventListener('mouseup',()=>{dragging=null;connecting=null;});
    document.addEventListener('click',()=>{contextMenu.style.display='none';});

    function saveNodeConfig(){
      if(!editingNode) return;
      editingNode.label=document.getElementById('nodeLabel').value||editingNode.label;
      try{ editingNode.config=JSON.parse(document.getElementById('nodeConfig').value||'{}'); }
      catch(e){ alert('Config JSON tidak valid!'); return; }
      closeEditModal(); render(); saveFlow();
    }
    function closeEditModal(){ editModal.style.display='none'; editingNode=null; }

    function deleteNode(id){nodes=nodes.filter(n=>n.id!==id);edges=edges.filter(e=>e.source!==id&&e.target!==id);render();saveFlow();}
    function resetCanvas(){if(confirm('Hapus semua?')){nodes=[];edges=[];localStorage.removeItem('nodes');localStorage.removeItem('edges');render();}}
    function saveFlow(){localStorage.setItem('nodes',JSON.stringify(nodes));localStorage.setItem('edges',JSON.stringify(edges));}
    function loadFlow(){location.reload();}
    function exportFlow(){
      const flow=nodes.map(n=>({id:n.id,type:n.type==='input'?'inject':n.type==='output'?'debug':n.type==='function'?'function':n.type,name:n.label,x:n.x,y:n.y,config:n.config||{},wires:edges.filter(e=>e.source===n.id).map(e=>[e.target])}));
      const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(flow,null,2)],{type:'application/json'}));a.download='flow-ngemiel.json';a.click();
    }

    render();
  </script>
</body>
</html>
